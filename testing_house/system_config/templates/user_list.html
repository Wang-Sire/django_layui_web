{% extends "base_iframe.html"  %}
{% load staticfiles %}
{% block iframe_info  %}
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-form layui-card-header layuiadmin-card-header-auto"style="padding: 10px 0 2px 0;">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">登录名</label>
                        <div class="layui-input-inline">
                            <input type="text" name="username" placeholder="请输入登录名" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">角色</label>
                        <div class="layui-input-inline">
                            <select name="role" class="layui-select-tips">
                                <option value="">请选择角色</option>
                                {% for info in role_info %}
                                    <option value="{{ info.name }}">{{ info.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <button class="layui-btn layui-btn-sm layui-btn-normal" lay-submit lay-filter="LAY-user-back-search">
                            <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>查询
                        </button>
                    </div>
                </div>
            </div>
            <div class="layui-card-body">
                <div style="padding-bottom: 10px;">
                    <button class="layui-btn layui-btn-sm layui-btn-normal" data-type="add">
                        <i class="layui-icon layui-icon-add-1"></i>新增
                    </button>
                    <button class="layui-btn layui-btn-sm layui-btn-normal" data-type="batchdel">
                        <i class="layui-icon layui-icon-delete"></i>删除
                    </button>
                    <button class="layui-btn layui-btn-sm layui-btn-normal" data-type="locking"><i>
                        <svg t="1563845469759" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14516" width="16" height="14"><path d="M289.2 405h445v-2.8c0-122.9-99.6-222.5-222.5-222.5s-222.5 99.6-222.5 222.5v2.8z m-112.7 0v-2.8C176.6 217.1 326.6 67 511.7 67s335.2 150.1 335.2 335.2c0 0.9 0 1.8 0.1 2.8h54.7v552H124.3V405h52.2z m373.1 302.5c28.2-12.9 47.9-41.3 47.9-74.4 0-45.1-36.6-81.7-81.7-81.7s-81.7 36.6-81.7 81.7c0 33.1 19.6 61.5 47.9 74.4v69.3c0 18.7 15.1 33.8 33.8 33.8 18.7 0 33.8-15.1 33.8-33.8v-69.3zM237 517.6v326.7h552V517.6H237z" fill="#ffffff" p-id="14517"></path></svg>
                        </i>锁定
                    </button>
                    <button class="layui-btn layui-btn-sm layui-btn-normal" data-type="unlock"><i>
                        <svg t="1563845749046" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="17291" width="16" height="14"><path d="M831.974802 384.050396H384.010079V256.060475a127.541956 127.541956 0 0 1 247.916477-42.556648 63.99496 63.99496 0 0 0 120.6305-42.876624A255.531877 255.531877 0 0 0 256.020158 256.060475v127.989921H192.025198a63.99496 63.99496 0 0 0-63.99496 63.99496v511.959684a63.99496 63.99496 0 0 0 63.99496 63.99496h639.949604a63.99496 63.99496 0 0 0 63.99496-63.99496V448.045356a63.99496 63.99496 0 0 0-63.99496-63.99496z m-63.99496 511.959683H256.020158V512.040317h511.959684z" p-id="17292" fill="#ffffff"></path></svg>
                        </i>解锁
                    </button>
                    <button class="layui-btn layui-btn-sm layui-btn-normal" data-type="import">
                        <i><svg t="1563844655374" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5915" width="16" height="14"><path d="M467.476179 711.099612c7.764658 6.256879 18.254606 7.71628 27.277089 3.330015a25.325846 25.325846 0 0 0 14.690765-23.140777V517.33794c163.694789 0.628913 276.802389 12.312183 413.840938 252.774684a25.680618 25.680618 0 0 0 22.455423 12.92497c2.096377 0 4.410455-0.209638 6.506831-0.830488a25.446791 25.446791 0 0 0 19.101219-24.60824v-20.238101c1.048188-169.967794 2.934928-520.336888-461.904411-537.019211V25.576283a25.55161 25.55161 0 0 0-14.690765-23.140777c-9.022484-4.176628-19.722069-2.926865-27.277089 3.330014L62.028811 338.412166a25.608051 25.608051 0 0 0-9.441759 19.601125c0 7.71628 3.354203 14.81171 9.232121 19.609188l405.648943 333.477133zM458.034419 79.799879v145.577254a25.761248 25.761248 0 0 0 25.39035 25.648366c193.277893 1.878676 318.568668 60.480475 383.201583 179.56275 40.718091 74.663272 50.571063 162.880427 52.885141 236.922849C787.512311 477.087502 663.479362 466.460484 483.618281 466.258909c-6.708406 0-13.424876 2.709164-18.254605 7.498579a25.479043 25.479043 0 0 0-7.546957 18.141724v145.375679L118.68743 358.005228 458.026356 79.799879z m513.523663 916.81015c0 13.973159-11.546199 25.438728-25.817688 25.438728H83.436045a25.720933 25.720933 0 0 1-25.817689-25.648366v-471.120407a25.720933 25.720933 0 0 1 25.817689-25.656429 25.720933 25.720933 0 0 1 25.809626 25.648366v445.891317h810.685097v-86.757755a25.720933 25.720933 0 0 1 25.809626-25.656429 25.720933 25.720933 0 0 1 25.817688 25.656429v112.204546z" fill="#ffffff" p-id="5916"></path></svg>
                        </i>导入
                    </button>
                    <button class="layui-btn layui-btn-sm layui-btn-normal" data-type="export">
                        <i><svg t="1563844721277" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6770" width="16" height="14"><path d="M529.52869 714.530744c9.03042 4.168506 19.729854 2.918761 27.284767-3.33803l405.441653-333.682068a25.398055 25.398055 0 0 0 9.231992-19.600849c0-7.716171-3.354156-14.811501-9.441626-19.608911L556.805395 5.868563c-7.756485-6.248728-18.246285-7.708108-27.276705-3.329967a25.325489 25.325489 0 0 0-14.690558 23.14045v174.561237C50.013407 216.930434 51.90012 567.29459 52.738659 737.050353v20.237816c0 11.675043 7.764548 21.689133 19.10095 24.59983 2.096347 0.628904 4.40233 0.838539 6.498677 0.838539 9.03042 0 17.633507-4.79741 22.455106-12.932851C238.039644 529.544211 350.944078 517.869168 514.838132 517.248327v174.141967c0 9.796393 5.668201 18.770372 14.690558 23.14045zM104.582943 667.185544c2.305982-74.033315 12.174941-162.249227 52.884395-236.911446 64.632003-118.870961 189.921013-177.681569 383.196181-179.560219 14.061653-0.209635 25.398055-11.473471 25.398056-25.446433V79.700307l339.334143 278.20949-339.124509 279.039967V491.584197c0-6.667997-2.733315-13.344058-7.562976-18.141468a25.801199 25.801199 0 0 0-18.254348-7.506537c-179.84242 0.209635-303.873621 10.844566-435.870942 201.249352z m861.880988 329.303928c0 13.972962-11.546037 25.446432-25.817325 25.446432H78.346348a25.72057 25.72057 0 0 1-25.817324-25.656067v-112.194901a25.72057 25.72057 0 0 1 25.817324-25.656067 25.72057 25.72057 0 0 1 25.809262 25.656067v86.756531h810.673672V525.16607a25.72057 25.72057 0 0 1 25.809261-25.656068 25.72057 25.72057 0 0 1 25.817325 25.656068v471.323402z" fill="#ffffff" p-id="6771"></path></svg>
                        </i>导出
                    </button>
                </div>
                <table id="LAY-user-back-manage" lay-filter="LAY-user-back-manage"></table>
                <script id="checkboxTpl" type="text/html">
                  <input type="checkbox" name="locking" value="{{d.id}}" title="锁定" lay-filter="lockDemo">
                </script>
                <script type="text/html" id="table-useradmin-admin">
                    <a href="javascript:void(0)" lay-event="edit" style="color: #1E9FFF">编辑 |</a>
                    <a href="javascript:void(0)" lay-event="reset" style="color: #1E9FFF">重置密码</a>
                </script>
            </div>
        </div>
    </div>
{% endblock  %}
{% block script_info  %}
    <script>
        layui.config({
            base: '{% static "/layuiadmin/" %}'
        }).extend({
            index: '/lib/index'
        }).use(['index', 'useradmin', 'table'], function(){
            let $ = layui.$
                ,form = layui.form
                ,table = layui.table;
            form.on('submit(LAY-user-back-search)', function(data){
                let field = data.field;
                $.ajax({
                    type:'get',
                    url:'{% url 'user_data' %}',
                    data: field
                });
                table.reload('LAY-user-back-manage', {
                    where: field
                    ,text: 'aaaaaaa'
                });
            });
            let active = {
                batchdel: function(){
                    let checkStatus = table.checkStatus('LAY-user-back-manage')
                    ,checkData = checkStatus.data; //得到选中的数据
                    delList=[];
                    checkData.forEach(function(n,i){
                        delList.push(n.id);
                    });
                    if(checkData.length === 0){
                        return layer.msg('请选择要删除的数据！',{
                                            icon: 3,
                                            offset: '1px',
                                            shift:6,
                                        });
                    }
                    layer.confirm('确定删除选中用户吗？', {
                        icon: 3
                        ,title: '提示'
                        ,area: ['100%', '160px']
                        ,offset: '0px'
                        ,anim: 1
                        ,btnAlign: 'c'
                    }, function() {
                        $.ajax({
                            url: '/user_del_more',
                            type: "GET",
                            data: "id="+delList,
                            success: function (msg) {
                                if (msg === '1') {
                                    layer.msg("删除成功",{
                                            icon: 1,
                                            offset: '1px',
                                            shift:6,
                                        });
                                } else {
                                    layer.msg("删除失败!",{
                                            icon: 2,
                                            offset: '1px',
                                            shift:6,
                                        });
                                }
                            layer.load(3);
                            table.reload('LAY-user-back-manage');
                            }
                        });
                    });}
                    ,add: function(){
                    layer.open({
                        type: 2
                        ,title: '新增'
                        ,content: '{% url 'user_add' %}'
                        ,area: ['100%', '520px']
                        ,btn: ['保存', '取消']
                        ,offset: '0px'
                        ,anim: 1
                        ,btnAlign: 'c'
                        ,yes: function(index, layero){
                            var iframeWindow = window['layui-layer-iframe'+ index]
                                ,submit = layero.find('iframe').contents().find("#LAY-user-front-submit");
                            iframeWindow.layui.form.on('submit(LAY-user-front-submit)', function(data){
                                var field = data.field;
                                $.ajax({
                                    type:'get',
                                    url:'{% url 'user_list' %}',
                                    data: field,
                                    success:function(e){
                                        if(e === '0'){
                                            layer.close(index);
                                            layer.confirm('保存成功 默认密码为 eLTE@com123 请及时修改密码！', {
                                                icon: 1
                                                ,title: '提示'
                                                ,area: ['100%', '160px']
                                                ,offset: '0px'
                                                ,anim: 1
                                                ,btnAlign: 'c'
                                                });
                                        } else if (e === '1') {
                                            layer.msg('用户已存在!',{
                                                icon: 3,
                                                offset: '1px',
                                                shift:6,
                                            });
                                        }else {
                                            layer.msg('保存失败!',{
                                                icon: 2,
                                                offset: '1px',
                                                shift:6,
                                            });
                                        }
                                        layer.load(3);
                                        table.reload('LAY-user-back-manage');
                                    }
                                });
                            });
                            submit.trigger('click');
                        }
                    });
                }
            };

            $('.layui-btn.layui-btn-sm.layui-btn-normal').on('click', function(){
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
        });
    </script>
{% endblock %}


